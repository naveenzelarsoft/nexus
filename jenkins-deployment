pipeline {
    agent {
        label "Ansible"
        }
        parameters{
            choice(name: 'ENV', choices: ['dev', 'prod' ], description: 'Select Environment')
            string(name: 'COMPONENT' , defaultValue: '', description: 'which Component to deploy')
            string(name: 'VERSION', defaultValue:'', description: 'Which Version of Component to deploy')
        }
       stages {

        stage('Find Then Server'){
           steps {
            sh '''
            aws ec2 describe-instances --filters "Name=tag:Name,Values=${COMPONENT}-${ENV}" --region us-east-1 | jq .Reservations[].Instances[].PrivateIpAddress | xargs -n1 > ips
           '''
            }
         }
        stage('Deploy to DEV'){
           when { environment name: 'ENV', value: 'dev' }
           steps {
             git branch: 'master' , url: "https://github.com/naveenzelarsoft/ansible.git"
             sh '''
                ansible-playbook -i ips todo.yml -t ${COMPONENT} -e COMPONENT=${COMPONENT} -e APPVERSION=${VERSION} -e ansible_password=DevOps321
             '''
            }
        }
        stage('Deploy to PROD') {
           when { environment name: 'ENV', value: 'prod' }
           steps {
              sh 'ansible --version'
             }
         }
     }
  }